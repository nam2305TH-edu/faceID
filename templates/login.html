<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập - Hệ thống điểm danh FaceID</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- CSS Files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="logo">
                <i class="fas fa-id-card"></i>
                <h2>FaceID System</h2>
                <p>Hệ thống điểm danh nhận diện khuôn mặt</p>
            </div>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="login-message {{ 'error' if category == 'danger' else category }}">
                            <i class="fas {{ 'fa-exclamation-circle' if category == 'danger' else 'fa-check-circle' }}"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Login Tabs -->
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchTab('password')">
                    <i class="fas fa-key me-2"></i>Mật khẩu
                </button>
                <button class="tab-btn" onclick="switchTab('faceid')">
                    <i class="fas fa-camera me-2"></i>FaceID
                </button>
            </div>
            
            <!-- Password Login Tab -->
            <div id="password-tab" class="tab-content active">
                <form method="POST" class="login-form">
                    <div class="form-group">
                        <label for="username" class="form-label">Tên đăng nhập</label>
                        <div class="input-wrapper">
                            <input type="text" class="form-control" id="username" name="username" 
                                   placeholder="Nhập tên đăng nhập" required>
                            <i class="fas fa-user input-icon"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="password" class="form-label">Mật khẩu</label>
                        <div class="input-wrapper">
                            <input type="password" class="form-control" id="password" name="password" 
                                   placeholder="Nhập mật khẩu" required>
                            <i class="fas fa-lock input-icon"></i>
                        </div>
                    </div>
                    
                    <div class="remember-me">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="remember">
                            <label class="form-check-label" for="remember">Ghi nhớ đăng nhập</label>
                        </div>
                        <a href="{{ url_for('auth.password_recovery') }}" class="forgot-password">Quên mật khẩu?</a>
                    </div>
                    
                    <button type="submit" class="btn-login">
                        <i class="fas fa-sign-in-alt"></i> Đăng nhập
                    </button>
                </form>
            </div>
            
            <!-- FaceID Login Tab -->
            <div id="faceid-tab" class="tab-content">
                <div class="camera-container">
                    <video id="loginVideo" autoplay playsinline></video>
                    <div class="camera-overlay">
                        <div class="face-guide"></div>
                    </div>
                </div>
                
                <div class="face-status waiting" id="faceStatus">
                    <i class="fas fa-camera me-2"></i>
                    <span id="statusText">Nhấn "Bật Camera" để bắt đầu</span>
                </div>
                
                <div class="user-preview" id="userPreview">
                    <div class="avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h5 id="previewName">-</h5>
                    <p class="text-muted mb-0" id="previewDept">-</p>
                    <div class="countdown-timer mt-2" id="countdownTimer"></div>
                </div>
                
                <button class="btn-login" onclick="startFaceLogin()" id="btnStartCamera">
                    <i class="fas fa-camera"></i> Bật Camera
                </button>
                <button class="btn-login" onclick="stopCamera()" id="btnStopCamera" style="display:none; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);">
                    <i class="fas fa-stop"></i> Tắt Camera
                </button>
            </div>
            
            <div class="login-divider">
                <span>hoặc</span>
            </div>
            
            <div class="alternative-actions">
                <a href="{{ url_for('attendance.index') }}" class="btn btn-face-login">
                    <i class="fas fa-clock"></i> Đi đến trang Điểm danh
                </a>
            </div>
        </div>
        
        
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let videoStream = null;
        let recognitionInterval = null;
        let currentRecognizedUser = null;
        let recognitionStartTime = null;
        let countdownInterval = null;
        const AUTO_LOGIN_DELAY = 2000; 
        
        const video = document.getElementById('loginVideo');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 640;
        canvas.height = 480;
        
        // Chuyển tab
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'password') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('password-tab').classList.add('active');
                stopCamera();
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('faceid-tab').classList.add('active');
                // Tự động bật camera khi chuyển sang tab FaceID
                startFaceLogin();
            }
        }
        
        // Bắt đầu đăng nhập FaceID
        function startFaceLogin() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user' 
                    } 
                })
                .then(stream => {
                    video.srcObject = stream;
                    videoStream = stream;
                    
                    document.getElementById('btnStartCamera').style.display = 'none';
                    document.getElementById('btnStopCamera').style.display = 'block';
                    
                    updateStatus('recognizing', 'Đang nhận diện khuôn mặt...');
                    
                    // Bắt đầu nhận diện
                    recognitionInterval = setInterval(recognizeFace, 2000);
                })
                .catch(error => {
                    console.error("Camera error: ", error);
                    updateStatus('error', 'Không thể truy cập camera');
                });
            }
        }
        
        // Dừng camera
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (recognitionInterval) {
                clearInterval(recognitionInterval);
                recognitionInterval = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            document.getElementById('btnStartCamera').style.display = 'block';
            document.getElementById('btnStopCamera').style.display = 'none';
            document.getElementById('userPreview').classList.remove('show');
            document.getElementById('countdownTimer').textContent = '';
            
            currentRecognizedUser = null;
            recognitionStartTime = null;
            
            updateStatus('waiting', 'Nhấn "Bật Camera" để bắt đầu');
        }
        
        // Nhận diện khuôn mặt
        async function recognizeFace() {
            if (!videoStream) return;
            
            try {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                const response = await fetch('/login/face', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Nhận diện thành công
                    if (currentRecognizedUser !== data.user.id) {
                        // User mới, reset timer
                        currentRecognizedUser = data.user.id;
                        recognitionStartTime = Date.now();
                        startCountdown(data);
                    }
                    
                    // Cập nhật preview
                    document.getElementById('previewName').textContent = data.user.name;
                    document.getElementById('previewDept').textContent = data.user.department + ' - ' + data.user.role;
                    document.getElementById('userPreview').classList.add('show');
                    
                    updateStatus('success', `Xin chào ${data.user.name}! (${data.confidence}%)`);
                    
                    // Kiểm tra đã đủ 5 giây chưa
                    checkAutoLogin(data);
                    
                } else {
                    // Không nhận diện được
                    resetRecognition();
                    updateStatus('error', data.error || 'Không nhận diện được');
                }
            } catch (error) {
                console.error('Recognition error:', error);
                updateStatus('error', 'Lỗi kết nối server');
            }
        }
        
        // Bắt đầu đếm ngược
        function startCountdown(data) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                const elapsed = Date.now() - recognitionStartTime;
                const remaining = Math.max(0, Math.ceil((AUTO_LOGIN_DELAY - elapsed) / 1000));
                
                document.getElementById('countdownTimer').innerHTML = 
                    `<i class="fas fa-clock me-1"></i> Đăng nhập sau ${remaining}s`;
                
                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 100);
        }
        
        // Kiểm tra và thực hiện auto login
        function checkAutoLogin(data) {
            const elapsed = Date.now() - recognitionStartTime;
            
            if (elapsed >= AUTO_LOGIN_DELAY) {
                // Đã đủ 5 giây, thực hiện đăng nhập
                performLogin(data);
            }
        }
        
        // Thực hiện đăng nhập
        function performLogin(data) {
            stopCamera();
            
            updateStatus('success', 'Đăng nhập thành công! Đang chuyển hướng...');
            document.getElementById('countdownTimer').innerHTML = 
                '<i class="fas fa-check-circle text-success"></i> Thành công!';
            
            // Phát âm thanh
            playSuccessSound();
            
            // Chuyển hướng sau 1 giây
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 1000);
        }
        
        // Reset recognition
        function resetRecognition() {
            currentRecognizedUser = null;
            recognitionStartTime = null;
            document.getElementById('userPreview').classList.remove('show');
            document.getElementById('countdownTimer').textContent = '';
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }
        
        // Cập nhật trạng thái
        function updateStatus(type, message) {
            const statusEl = document.getElementById('faceStatus');
            statusEl.className = 'face-status ' + type;
            
            let icon = 'fa-camera';
            if (type === 'recognizing') icon = 'fa-spinner fa-spin';
            else if (type === 'success') icon = 'fa-check-circle';
            else if (type === 'error') icon = 'fa-exclamation-circle';
            
            document.getElementById('statusText').innerHTML = `<i class="fas ${icon} me-2"></i>${message}`;
        }
        
        // Phát âm thanh thành công
        function playSuccessSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        // Dọn dẹp khi trang đóng
        window.addEventListener('beforeunload', function() {
            stopCamera();
        });
    </script>
</body>
</html>
