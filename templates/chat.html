{% extends "base.html" %}

{% block title %}ChatAI - Tr·ª£ l√Ω th√¥ng minh{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <div class="d-flex align-items-center">
            <div class="chat-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="ms-3">
                <h4 class="mb-0">ChatAI Assistant</h4>
                <small class="text-muted">Tr·ª£ l√Ω t√¨m ki·∫øm th√¥ng minh</small>
            </div>
        </div>
        <button class="btn btn-outline-danger btn-sm" onclick="clearChat()">
            <i class="fas fa-trash me-1"></i>X√≥a cu·ªôc tr√≤ chuy·ªán
        </button>
    </div>
    
    <div class="chat-messages" id="chatMessages">
        <!-- Welcome message -->
        <div class="message bot-message">
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <p>Xin ch√†o <strong>{{ current_user.full_name }}</strong>! üëã</p>
                <p>T√¥i l√† ChatAI, tr·ª£ l√Ω th√¥ng minh c√≥ th·ªÉ gi√∫p b·∫°n:</p>
                <ul>
                    <li>üîç T√¨m ki·∫øm th√¥ng tin tr√™n internet</li>
                    <li>üì∞ C·∫≠p nh·∫≠t tin t·ª©c m·ªõi nh·∫•t</li>
                    <li>üí° Tr·∫£ l·ªùi c√°c c√¢u h·ªèi</li>
                    <li>üìä Ph√¢n t√≠ch v√† t·ªïng h·ª£p th√¥ng tin</li>
                </ul>
                <p>H√£y ƒë·∫∑t c√¢u h·ªèi ƒë·ªÉ b·∫Øt ƒë·∫ßu!</p>
            </div>
        </div>
    </div>
    
    <div class="chat-input-container">
        <form id="chatForm" onsubmit="sendMessage(event)">
            <div class="input-group">
                <input type="text" class="form-control" id="chatInput" 
                       placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." autocomplete="off">
                <button type="submit" class="btn btn-primary" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
        <div class="chat-suggestions">
            <span class="suggestion-label">G·ª£i √Ω:</span>
            <button class="suggestion-btn" onclick="askSuggestion('Th·ªùi ti·∫øt h√¥m nay th·∫ø n√†o?')">
                üå§Ô∏è Th·ªùi ti·∫øt
            </button>
            <button class="suggestion-btn" onclick="askSuggestion('Tin t·ª©c m·ªõi nh·∫•t v·ªÅ c√¥ng ngh·ªá')">
                üíª Tin c√¥ng ngh·ªá
            </button>
            <button class="suggestion-btn" onclick="askSuggestion('Gi√° v√†ng h√¥m nay')">
                üí∞ Gi√° v√†ng
            </button>
        </div>
    </div>
</div>

<script>
let sessionId = null;
let isProcessing = false;

function sendMessage(e) {
    e.preventDefault();
    
    const input = document.getElementById('chatInput');
    const query = input.value.trim();
    
    if (!query || isProcessing) return;
    
    // Hi·ªÉn th·ªã tin nh·∫Øn user
    addMessage(query, 'user');
    input.value = '';
    
    // Hi·ªÉn th·ªã typing indicator
    showTyping();
    
    isProcessing = true;
    document.getElementById('sendBtn').disabled = true;
    
    // G·ª≠i request
    fetch('/chat/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            query: query,
            session_id: sessionId
        })
    })
    .then(response => response.json())
    .then(data => {
        hideTyping();
        
        if (data.success) {
            sessionId = data.session_id;
            addMessage(data.answer, 'bot');
        } else {
            addMessage('‚ùå ' + (data.error || 'C√≥ l·ªói x·∫£y ra'), 'bot', true);
        }
    })
    .catch(error => {
        hideTyping();
        addMessage('‚ùå L·ªói k·∫øt n·ªëi server', 'bot', true);
    })
    .finally(() => {
        isProcessing = false;
        document.getElementById('sendBtn').disabled = false;
        input.focus();
    });
}

function addMessage(content, type, isError = false) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message ${isError ? 'error-message' : ''}`;
    
    const avatar = type === 'bot' 
        ? '<div class="message-avatar"><i class="fas fa-robot"></i></div>'
        : '<div class="message-avatar user"><i class="fas fa-user"></i></div>';
    
    // Format content v·ªõi markdown c∆° b·∫£n
    let formattedContent = content
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>');
    
    messageDiv.innerHTML = `
        ${avatar}
        <div class="message-content">
            <p>${formattedContent}</p>
            <small class="message-time">${new Date().toLocaleTimeString('vi-VN')}</small>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTyping() {
    const messagesContainer = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message typing-indicator';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
        <div class="message-avatar"><i class="fas fa-robot"></i></div>
        <div class="message-content">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTyping() {
    const typing = document.getElementById('typingIndicator');
    if (typing) typing.remove();
}

function askSuggestion(text) {
    document.getElementById('chatInput').value = text;
    document.getElementById('chatForm').dispatchEvent(new Event('submit'));
}

function clearChat() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a cu·ªôc tr√≤ chuy·ªán?')) return;
    
    sessionId = null;
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = `
        <div class="message bot-message">
            <div class="message-avatar"><i class="fas fa-robot"></i></div>
            <div class="message-content">
                <p>Cu·ªôc tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c x√≥a. H√£y ƒë·∫∑t c√¢u h·ªèi m·ªõi!</p>
            </div>
        </div>
    `;
}

// Focus input khi load trang
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('chatInput').focus();
});
</script>
{% endblock %}
