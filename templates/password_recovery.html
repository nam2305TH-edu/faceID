<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý mật khẩu - Hệ thống điểm danh FaceID</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="logo">
                <i class="fas fa-key"></i>
                <h2>Quản lý mật khẩu</h2>
                <p>Quên mật khẩu hoặc đổi mật khẩu</p>
            </div>
            
            <div id="messageBox" class="login-message" style="display: none;">
                <i class="fas fa-info-circle me-2"></i>
                <span id="messageText"></span>
            </div>
            
            <!-- Tabs -->
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchTab('forgot')">
                    <i class="fas fa-question-circle me-2"></i>Quên mật khẩu
                </button>
                <button class="tab-btn" onclick="switchTab('change')">
                    <i class="fas fa-edit me-2"></i>Đổi mật khẩu
                </button>
            </div>
            
            <!-- Quên mật khẩu Tab -->
            <div id="forgot-tab" class="tab-content active">
                <p class="text-center text-muted mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    Quét khuôn mặt để nhận mật khẩu mới (6 chữ số)
                </p>
                
                <div class="camera-container">
                    <video id="forgotVideo" autoplay playsinline></video>
                    <div class="camera-overlay">
                        <div class="face-guide"></div>
                    </div>
                </div>
                
                <div class="face-status waiting" id="forgotStatus">
                    <i class="fas fa-camera me-2"></i>
                    <span id="forgotStatusText">Nhấn để bật camera và quét khuôn mặt</span>
                </div>
                
                <div class="user-preview" id="forgotUserPreview">
                    <div class="avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h5 id="forgotPreviewName">-</h5>
                    <p class="text-muted mb-2" id="forgotPreviewDept">-</p>
                    <div class="new-password-box" id="newPasswordBox" style="display:none;">
                        <p class="mb-1">Mật khẩu mới của bạn:</p>
                        <h3 class="text-success" id="newPassword">------</h3>
                        <small class="text-muted">Hãy ghi nhớ mật khẩu này!</small>
                    </div>
                </div>
                
                <button class="btn-login" onclick="startForgotPassword()" id="btnForgotStart">
                    <i class="fas fa-camera"></i> Bật Camera & Quét FaceID
                </button>
                <button class="btn-login" onclick="stopForgotCamera()" id="btnForgotStop" style="display:none; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);">
                    <i class="fas fa-stop"></i> Tắt Camera
                </button>
            </div>
            
            <!-- Đổi mật khẩu Tab -->
            <div id="change-tab" class="tab-content">
                <!-- Sub-tabs cho đổi mật khẩu -->
                <div class="change-method-tabs mb-3">
                    <button class="method-btn active" onclick="switchChangeMethod('password')">
                        <i class="fas fa-key me-1"></i>Bằng mật khẩu cũ
                    </button>
                    <button class="method-btn" onclick="switchChangeMethod('face')">
                        <i class="fas fa-camera me-1"></i>Bằng FaceID
                    </button>
                </div>
                
                <!-- Đổi bằng mật khẩu cũ -->
                <div id="change-password-method" class="change-method active">
                    <form id="changePasswordForm" onsubmit="changePasswordByOld(event)">
                        <div class="form-group">
                            <label for="changeUsername" class="form-label">Tên đăng nhập</label>
                            <div class="input-wrapper">
                                <input type="text" class="form-control" id="changeUsername" name="username" 
                                       placeholder="Nhập tên đăng nhập" required>
                                <i class="fas fa-user input-icon"></i>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="oldPassword" class="form-label">Mật khẩu cũ</label>
                            <div class="input-wrapper">
                                <input type="password" class="form-control" id="oldPassword" name="old_password" 
                                       placeholder="Nhập mật khẩu cũ" required>
                                <i class="fas fa-lock input-icon"></i>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newPasswordInput" class="form-label">Mật khẩu mới</label>
                            <div class="input-wrapper">
                                <input type="password" class="form-control" id="newPasswordInput" name="new_password" 
                                       placeholder="Nhập mật khẩu mới" required minlength="6">
                                <i class="fas fa-key input-icon"></i>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
                            <div class="input-wrapper">
                                <input type="password" class="form-control" id="confirmPassword" name="confirm_password" 
                                       placeholder="Nhập lại mật khẩu mới" required minlength="6">
                                <i class="fas fa-check-double input-icon"></i>
                            </div>
                        </div>
                        <button type="submit" class="btn-login">
                            <i class="fas fa-save"></i> Đổi mật khẩu
                        </button>
                    </form>
                </div>
                
                <!-- Đổi bằng FaceID -->
                <div id="change-face-method" class="change-method">
                    <p class="text-center text-muted mb-3">
                        <i class="fas fa-info-circle me-1"></i>
                        Quét khuôn mặt để xác thực, sau đó nhập mật khẩu mới
                    </p>
                    
                    <div id="changeFaceStep1">
                        <div class="camera-container">
                            <video id="changeVideo" autoplay playsinline></video>
                            <div class="camera-overlay">
                                <div class="face-guide"></div>
                            </div>
                        </div>
                        
                        <div class="face-status waiting" id="changeStatus">
                            <i class="fas fa-camera me-2"></i>
                            <span id="changeStatusText">Nhấn để bật camera và quét khuôn mặt</span>
                        </div>
                        
                        <button class="btn-login" onclick="startChangeByFace()" id="btnChangeStart">
                            <i class="fas fa-camera"></i> Bật Camera & Quét FaceID
                        </button>
                        <button class="btn-login" onclick="stopChangeCamera()" id="btnChangeStop" style="display:none; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);">
                            <i class="fas fa-stop"></i> Tắt Camera
                        </button>
                    </div>
                    
                    <div id="changeFaceStep2" style="display:none;">
                        <div class="user-preview show mb-3">
                            <div class="avatar">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <h5 id="changePreviewName">-</h5>
                            <p class="text-muted mb-0" id="changePreviewDept">-</p>
                        </div>
                        
                        <form id="changeFacePasswordForm" onsubmit="changePasswordByFace(event)">
                            <input type="hidden" id="verifiedUserId" value="">
                            <div class="form-group">
                                <label for="faceNewPassword" class="form-label">Mật khẩu mới</label>
                                <div class="input-wrapper">
                                    <input type="password" class="form-control" id="faceNewPassword" 
                                           placeholder="Nhập mật khẩu mới" required minlength="6">
                                    <i class="fas fa-key input-icon"></i>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="faceConfirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
                                <div class="input-wrapper">
                                    <input type="password" class="form-control" id="faceConfirmPassword" 
                                           placeholder="Nhập lại mật khẩu mới" required minlength="6">
                                    <i class="fas fa-check-double input-icon"></i>
                                </div>
                            </div>
                            <button type="submit" class="btn-login">
                                <i class="fas fa-save"></i> Đổi mật khẩu
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="login-divider">
                <span>hoặc</span>
            </div>
            
            <div class="alternative-actions">
                <a href="{{ url_for('auth.login') }}" class="btn btn-face-login">
                    <i class="fas fa-arrow-left"></i> Quay lại đăng nhập
                </a>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Video elements
        const forgotVideo = document.getElementById('forgotVideo');
        const changeVideo = document.getElementById('changeVideo');
        
        // Canvas for capturing
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 640;
        canvas.height = 480;
        
        // Stream variables
        let forgotStream = null;
        let changeStream = null;
        let forgotInterval = null;
        let changeInterval = null;
        
        // ==================== Tab Switching ====================
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'forgot') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('forgot-tab').classList.add('active');
                stopChangeCamera();
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('change-tab').classList.add('active');
                stopForgotCamera();
            }
            hideMessage();
        }
        
        function switchChangeMethod(method) {
            document.querySelectorAll('.method-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.change-method').forEach(m => m.classList.remove('active'));
            
            if (method === 'password') {
                document.querySelector('.method-btn:first-child').classList.add('active');
                document.getElementById('change-password-method').classList.add('active');
                stopChangeCamera();
            } else {
                document.querySelector('.method-btn:last-child').classList.add('active');
                document.getElementById('change-face-method').classList.add('active');
            }
            hideMessage();
        }
        
        // ==================== Message Display ====================
        function showMessage(text, type = 'info') {
            const box = document.getElementById('messageBox');
            const textEl = document.getElementById('messageText');
            box.className = 'login-message ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
            textEl.textContent = text;
            box.style.display = 'block';
        }
        
        function hideMessage() {
            document.getElementById('messageBox').style.display = 'none';
        }
        
        // ==================== Forgot Password (FaceID) ====================
        function startForgotPassword() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' } 
                })
                .then(stream => {
                    forgotVideo.srcObject = stream;
                    forgotStream = stream;
                    
                    document.getElementById('btnForgotStart').style.display = 'none';
                    document.getElementById('btnForgotStop').style.display = 'block';
                    document.getElementById('forgotUserPreview').classList.remove('show');
                    document.getElementById('newPasswordBox').style.display = 'none';
                    
                    updateForgotStatus('recognizing', 'Đang quét khuôn mặt...');
                    
                    // Bắt đầu nhận diện
                    forgotInterval = setInterval(recognizeForgotFace, 2000);
                })
                .catch(error => {
                    console.error("Camera error: ", error);
                    updateForgotStatus('error', 'Không thể truy cập camera');
                });
            }
        }
        
        function stopForgotCamera() {
            if (forgotStream) {
                forgotStream.getTracks().forEach(track => track.stop());
                forgotStream = null;
            }
            if (forgotInterval) {
                clearInterval(forgotInterval);
                forgotInterval = null;
            }
            
            document.getElementById('btnForgotStart').style.display = 'block';
            document.getElementById('btnForgotStop').style.display = 'none';
            updateForgotStatus('waiting', 'Nhấn để bật camera và quét khuôn mặt');
        }
        
        function updateForgotStatus(status, text) {
            const statusEl = document.getElementById('forgotStatus');
            statusEl.className = 'face-status ' + status;
            document.getElementById('forgotStatusText').textContent = text;
        }
        
        function recognizeForgotFace() {
            if (!forgotStream) return;
            
            ctx.drawImage(forgotVideo, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            fetch('/password/forgot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Dừng camera
                    stopForgotCamera();
                    
                    // Hiển thị thông tin user và mật khẩu mới
                    document.getElementById('forgotPreviewName').textContent = data.user.name;
                    document.getElementById('forgotPreviewDept').textContent = data.user.department || 'N/A';
                    document.getElementById('newPassword').textContent = data.new_password;
                    document.getElementById('forgotUserPreview').classList.add('show');
                    document.getElementById('newPasswordBox').style.display = 'block';
                    
                    updateForgotStatus('success', 'Đã cấp mật khẩu mới thành công!');
                    showMessage('Mật khẩu mới đã được cấp. Hãy ghi nhớ mật khẩu!', 'success');
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }
        
        // ==================== Change Password by Old Password ====================
        function changePasswordByOld(e) {
            e.preventDefault();
            
            const username = document.getElementById('changeUsername').value;
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPasswordInput').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showMessage('Mật khẩu mới không khớp!', 'error');
                return;
            }
            
            fetch('/password/change', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: username,
                    old_password: oldPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    document.getElementById('changePasswordForm').reset();
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                showMessage('Có lỗi xảy ra!', 'error');
            });
        }
        
        // ==================== Change Password by FaceID ====================
        function startChangeByFace() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' } 
                })
                .then(stream => {
                    changeVideo.srcObject = stream;
                    changeStream = stream;
                    
                    document.getElementById('btnChangeStart').style.display = 'none';
                    document.getElementById('btnChangeStop').style.display = 'block';
                    document.getElementById('changeFaceStep2').style.display = 'none';
                    document.getElementById('changeFaceStep1').style.display = 'block';
                    
                    updateChangeStatus('recognizing', 'Đang quét khuôn mặt...');
                    
                    // Bắt đầu nhận diện
                    changeInterval = setInterval(recognizeChangeFace, 2000);
                })
                .catch(error => {
                    console.error("Camera error: ", error);
                    updateChangeStatus('error', 'Không thể truy cập camera');
                });
            }
        }
        
        function stopChangeCamera() {
            if (changeStream) {
                changeStream.getTracks().forEach(track => track.stop());
                changeStream = null;
            }
            if (changeInterval) {
                clearInterval(changeInterval);
                changeInterval = null;
            }
            
            document.getElementById('btnChangeStart').style.display = 'block';
            document.getElementById('btnChangeStop').style.display = 'none';
            updateChangeStatus('waiting', 'Nhấn để bật camera và quét khuôn mặt');
        }
        
        function updateChangeStatus(status, text) {
            const statusEl = document.getElementById('changeStatus');
            statusEl.className = 'face-status ' + status;
            document.getElementById('changeStatusText').textContent = text;
        }
        
        function recognizeChangeFace() {
            if (!changeStream) return;
            
            ctx.drawImage(changeVideo, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            fetch('/password/verify-face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Dừng camera
                    stopChangeCamera();
                    
                    // Hiển thị form đổi mật khẩu
                    document.getElementById('verifiedUserId').value = data.user.id;
                    document.getElementById('changePreviewName').textContent = data.user.name;
                    document.getElementById('changePreviewDept').textContent = data.user.department || 'N/A';
                    document.getElementById('changeFaceStep1').style.display = 'none';
                    document.getElementById('changeFaceStep2').style.display = 'block';
                    
                    updateChangeStatus('success', 'Xác thực thành công!');
                    showMessage('Đã xác thực khuôn mặt. Vui lòng nhập mật khẩu mới.', 'success');
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }
        
        function changePasswordByFace(e) {
            e.preventDefault();
            
            const userId = document.getElementById('verifiedUserId').value;
            const newPassword = document.getElementById('faceNewPassword').value;
            const confirmPassword = document.getElementById('faceConfirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showMessage('Mật khẩu mới không khớp!', 'error');
                return;
            }
            
            fetch('/password/change-by-face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    document.getElementById('changeFacePasswordForm').reset();
                    // Reset về bước 1
                    setTimeout(() => {
                        document.getElementById('changeFaceStep2').style.display = 'none';
                        document.getElementById('changeFaceStep1').style.display = 'block';
                    }, 2000);
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                showMessage('Có lỗi xảy ra!', 'error');
            });
        }
    </script>
</body>
</html>
